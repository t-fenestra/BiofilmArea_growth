---
title: "Biofilm colonisation area calculation"
author: "Tatyana Pichugina"
date: "5/13/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(ggridges)
library(gridExtra)
library(stringr)
library(modelr)
library(broom)
```


## Integral area
Sum of the colonize pixel across all data frames.


```{r Integral Area, echo=FALSE, message=FALSE, warning=FALSE}
# read file 
AreaY<-read_delim(file='../../data/ResultTable_SliceY.txt',col_names = TRUE,delim=',')

AreaY<-AreaY %>% 
  # new colums with strain
  separate(Experiment,c('Strain'),sep='_',remove=FALSE,extra="drop") %>%
  mutate(Strain=as.factor(Strain) )%>%
  # extract data frame
  mutate(frame=as.numeric(str_split(datafile,'_',simplify = TRUE)[,5]),data_stamp=as.numeric(str_split(datafile,'_',simplify = TRUE)[,3]))

# Integral area
IntegralArea<-AreaY %>%
  group_by(Strain,data_stamp,frame) %>%
  summarise(IntAreaTotal=sum(SumSliceY),IntAreaGain=sum(SumSliceYgain),IntAreaLost=sum(SumSliceYlost),
            IntAreaSame=sum(SumSliceYsame)) %>%
  mutate(GainTotal=IntAreaGain/IntAreaTotal,LostTotal=IntAreaLost/IntAreaTotal,SameTotal=IntAreaSame/IntAreaTotal) %>%
  filter(-IntAreaGain,-IntAreaLost,-IntAreaSame) %>%
  gather(key=Area_type,value='Area',IntAreaTotal,GainTotal,LostTotal,SameTotal,factor_key = TRUE) 


IntegralArea %>% filter(Area_type=='IntAreaTotal') %>% 
  ggplot(aes(x=frame,y=Area,color=Strain))+
  geom_line(aes(group=data_stamp),size=2)+
  ggtitle('Sum of areas across all Y-layers ') + 
  xlab("time frame in minutes") + ylab("Area")+
  theme_bw(base_size = 12)

```

#### After selection only first 15 frames
```{r echo=FALSE, message=FALSE, warning=FALSE}
AreaY<-AreaY %>% filter(frame %in% seq(from=1,to=15,by=1)) # frame 1-15
IntegralArea <- IntegralArea %>% filter(frame %in% seq(from=1,to=15,by=1)) # frame 1-15

IntegralArea %>% filter(Area_type=='IntAreaTotal') %>% 
  ggplot(aes(x=frame,y=Area,color=Strain))+
  geom_line(aes(group=data_stamp),size=2)+
  ggtitle('Sum of areas across all Y-layers ') + 
  xlab("time frame in minutes") + ylab("Area")+
  theme_bw(base_size = 12)
```

#### Gain-Lost-Same summary per experiment
1. GainTotal represents proportion of pixels that appear new between consecutive frames to the total number occupied pixels.
2. LostTotal is a proportion of pixels that lost between two consecutive frames to the total number occupied pixels.
3. SameTotal is a proportion of pixels that stays at the same place between two consecutive frames to the total number occupied pixels.
4. IntAreaTotal is a total occupied area.

#### dwss sum of colonisation area
```{r echo=FALSE, message=FALSE, warning=FALSE}
IntegralArea %>% filter(Strain=='dwss') %>%
  ggplot(aes(x=frame,y=Area))+
  geom_line(size=1)+
  facet_grid(Area_type~data_stamp,scales="free_y")+
  ggtitle('dwss Sum of areas across all Y-layers ') + 
  xlab("time frame in minutes") + ylab("Area")
 
```

#### SM sum of colonisation area 
```{r echo=FALSE, message=FALSE, warning=FALSE}
IntegralArea %>% filter(Strain=='SM') %>%
  ggplot(aes(x=frame,y=Area))+
  geom_line(aes(group=data_stamp),size=1)+
  facet_grid(Area_type~data_stamp,scales="free_y")+
  ggtitle('SM Sum of areas across all Y-layers ') + 
  xlab("time frame in minutes") + ylab("Area")
  
```
## Linear regression fit
```{r echo=FALSE, message=FALSE, warning=FALSE}
# model LogIntArea ~ Intersept + frame
fit_lm<-function(df){
  lm(log(Area)~frame,data=df)
}


## nest data by experiments
by_experiment<-IntegralArea %>%
  filter(Area_type=="IntAreaTotal" & Area>0) %>%
  ungroup(data_stamp) %>%
  select(-data_stamp,-Area_type) %>%
  mutate(frame=60*frame) %>%
  group_by(Experiment) %>%
  nest()




# calculate approximation coefficients
by_experiment <- by_experiment %>% 
  mutate(model = map(data, fit_lm)) %>%
  mutate(resids = map2(data,model, add_residuals)) %>%
  mutate(predict = map2(data,model, add_predictions))
  
  
DataPredict<-by_experiment %>% 
  unnest(predict) %>%
  mutate(pred=exp(pred)) %>%
  mutate(res=pred-Area) %>%
  gather(key="Area_type",value="Area",Area,pred,factor_key = TRUE) 
  
# plot fit to the data  
ggplot(DataPredict,aes(x=frame,y=Area,color=Area_type,group=Experiment))+
    geom_line(aes(group=Area_type),size=1)+
    facet_wrap(.~Experiment)+
    labs(title="Fit to the data")

#plot residuals
ggplot(DataPredict,aes(x=frame,y=res,group=Experiment))+
  geom_line(size=1)+
  facet_wrap(.~Experiment)+
  labs(title="Residuals")

# coefficients
Coeff<-by_experiment %>%
  mutate(tidy_model=map(model,broom::tidy)) %>%
  unnest(tidy_model) %>%
  filter(term=="frame") %>%
  arrange(estimate) %>%
  separate(Experiment,c('Strain'),sep='_',remove=FALSE,extra="drop") %>%
  mutate(Strain=as.factor(Strain))
 

  ggplot(Coeff,aes(x=Experiment,y=estimate,fill=Strain,label = Experiment))+
  geom_bar(stat="identity", position=position_dodge())+
  geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.2,
                position=position_dodge(.9))+
  ylab("growth rate 1/min")+
  xlab("Experiment")+
  labs(title="Growth rate estimate")
  coord_flip()+
  theme_grey(base_size = 12)

  
# per model statistics
glance<-by_experiment %>%
  mutate(glance=map(model,broom::glance)) %>%
  unnest(glance,.drop=TRUE) 

glance$Experiment <- factor(glance$Experiment, levels =Coeff$Experiment)
glance %>% ggplot(aes(y=r.squared,x=by_experiment$Experiment)) + 
  geom_col()+
  xlab("Experiment")+
  coord_flip()|+
  labs(title="Quality of model fit R.squared")
```

## Colonisation area per Layer 
LayerSize=32 mkm (200px)
```{r fig.height=14, fig.width=10, echo=FALSE,message=FALSE, warning=FALSE}
ggplot(AreaY,aes(x=frame,y=SumSliceY,color=Strain))+
  geom_line(aes(group=Experiment),size=1)+facet_grid(Layer~.)+
  theme_bw(base_size = 10)+
  labs(title="Area per layer from ALI")+
  ylab("Area per Layer")
```
#### Plot shows ratio  between Area per Layer to total colonization area for different time frames
```{r,fig.height=14, fig.width=12,echo=FALSE,message=FALSE, warning=FALSE}
AreaTotal<-AreaY %>% group_by(data_stamp,frame,Strain) %>%
    summarise(AreaTotal=sum(SumSliceY))

AreaYSumSliceY<-AreaY %>% select(data_stamp,Strain,Layer,frame,SumSliceY) %>%
  inner_join(AreaTotal,by=c("data_stamp","frame","Strain")) %>% 
  filter(AreaTotal!=0) %>% 
  mutate(Ratio=SumSliceY/AreaTotal) 


AreaYSumSliceY %>% filter(Strain=='dwss') %>%
  ggplot(aes(x=Layer,y=Ratio),color=as.numeric(Layer))+geom_bar(size=1,stat="identity",fill="darkblue")+
  scale_x_reverse()+
  coord_flip()+
  facet_grid(frame~data_stamp)+
  ggtitle('dwss ratio')+
  theme_gray(base_size = 10)
  
AreaYSumSliceY %>% filter(Strain=='SM') %>%
  ggplot(aes(x=Layer,y=Ratio),color=as.numeric(Layer))+geom_bar(size=1,stat="identity",fill="darkblue")+
  scale_x_reverse()+
  coord_flip()+
  facet_grid(frame~data_stamp)+
  ggtitle('SM ratio')+
  theme_gray(base_size = 10)
```
#### Gain-Lost-Same


